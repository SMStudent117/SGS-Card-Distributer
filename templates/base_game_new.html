<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>桌游角色记录器</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: url("/static/icons/datingbg.png") no-repeat center center;
            background-size: cover;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* 游戏角色区 */
        .game-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .character-card {
            max-height: 80vh;
            max-width: 40vw;
            width: auto;
            height: auto;
        }

        .side-panel {
            position: absolute;
            right: 2vw;
            top: 50%;
            transform: translateY(-50%);
            height: 70vh;
            width: auto;
        }

        /* 导航栏背景 */
        .nav-bar {
            background-color: #4b2e2e;
            /* 深棕色背景 */
            border-radius: 1vh;
            /* 圆角 */
            box-shadow: 0 0.5vh 1vh rgba(0, 0, 0, 0.5);
            /* 阴影增加立体感 */
            width: 90vw;
            height: 12vh;
            margin: 0 auto 1vh auto;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* 导航栏内容整体收缩 */
        .nav-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }


        /* 左中右三块 */
        .nav-left,
        .nav-center,
        .nav-right {
            display: flex;
            align-items: center;
            gap: 2vw;
        }

        .nav-center {
            flex: 1;
            justify-content: center;
        }

        .nav-bar img.icon {
            height: 10vh;
            width: auto;
        }

        .nav-button {
            background: url("/static/icons/std_btn.png") no-repeat center center;
            background-size: contain;
            border: none;
            width: 9vw;
            height: 10vh;
            font-size: 4vh;
            font-weight: bold;
            color: #fff;
            text-shadow: 0.3vh 0.3vh 0.5vh #000;
            cursor: pointer;
        }

        .hp-display {
            font-size: 4vh;
            font-weight: bold;
            color: green;
            min-width: 2vw;
            text-align: center;
        }

        /* 浮动按钮 */
        .floating-btn {
            position: fixed;
            /* 固定在屏幕左下角 */
            left: 2vw;
            /* 距离屏幕左边 2% */
            bottom: 14vh;
            /* 导航栏高度 12vh + 一点间距 */
            z-index: 10;
            /* 保证在导航栏之上 */
            cursor: pointer;
        }

        .floating-btn img {
            height: 15vh;
            /* 大小随屏幕自适应 */
            width: auto;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 800px;
        }

        .modal-content h2 {
            margin-bottom: 20px;
        }

        .faction-images img {
            width: 100px;
            height: auto;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .faction-images img:hover {
            transform: scale(1.1);
        }

        /* 废除弹窗 */
        .abolish-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .abolish-buttons button {
            height: 50px;
            font-size: 16px;
        }

        .suit {
            font-size: 15px;
            font-weight: bold;
            color: transparent;
            /* 隐藏原始字体颜色 */
            text-shadow: 0 0 0 gray;
            /* 初始灰色 */
            border: 1px solid #aaa;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            background: white;
        }

        /* 激活状态：不同花色显示不同颜色 */
        .suit.active.spade,
        .suit.active.club {
            text-shadow: 0 0 0 black;
        }

        .suit.active.heart,
        .suit.active.diamond {
            text-shadow: 0 0 0 red;
        }

        .side-panel-wrapper {
            position: absolute;
            right: 2vw;
            top: 50%;
            transform: translateY(-50%);
            height: 70vh;
            width: 15vw;
            /* ✅ 给 wrapper 一个明确宽度 */
        }

        .marker-list {
            position: absolute;
            top: 10%;
            /* 距离图片顶部 10% */
            bottom: 10%;
            /* 距离图片底部 10% */
            left: 0;
            /* 左边对齐图片 */
            right: 0;
            /* 右边对齐图片 */
            overflow-y: auto;
            color: white;
            /* 确保可见 */
            background: rgba(0, 0, 0, 0.3);
            font-size: 14px;
            z-index: 10;
            /* 浮在 side-panel 上 */
            padding: 5px;
            box-sizing: border-box;
        }

        .side-panel {
            height: 100%;
            width: auto;
            display: block;
        }

        .suit-buttons {
            position: absolute;
            bottom: 0;
            /* 固定在 side-panel 的最底部 */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5vw;
            /* 按钮之间的间距 */
            justify-content: center;
            width: 100%;
            padding-bottom: 5px;
            z-index: 15;
            /* 确保在 side-panel 图片上方 */
        }

        .suit-buttons .suit {
            font-size: 2vh;
            /* 调整文字大小，适配 std_btn */
            font-weight: bold;
            color: white;
            text-shadow: 0.2vh 0.2vh 0.4vh #000;
        }
    </style>
</head>

<body>
    <!-- 游戏角色区 -->
    <div class="game-area">
        {% if image_file %}
        <img id="characterImage" src="{{ url_for('static', filename=image_file) }}" alt="角色卡" class="character-card">
        <img id="chainOverlay" src="/static/icons/chain_mode.png"
            style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:100%; height:auto; pointer-events:none;">
        {% else %}
        <div style="color:white;">⚠️ 没有找到角色图片</div>
        {% endif %}
        <!-- 侧边面板 + 标记列表 -->
        <div class="side-panel-wrapper">
            <img src="/static/icons/side_panel.png" alt="侧边面板" class="side-panel">
            <div id="markerList" class="marker-list"></div>
            <div class="suit-buttons">
                <button class="suit spade nav-button">♠</button>
                <button class="suit heart nav-button">♥</button>
                <button class="suit diamond nav-button">♦</button>
                <button class="suit club nav-button">♣</button>
            </div>
        </div>
    </div>

    <!-- 浮动按钮 -->
    <div class="floating-btn">
        <img src="/static/icons/ex_btn.png" alt="扩展按钮">
    </div>

    <!-- 导航栏 -->
    <div class="nav-bar">
        <div class="nav-content">
            <!-- 左侧 -->
            <div class="nav-left">
                <img id="factionIcon" src="/static/icons/qun.png" alt="阵营图标" class="icon">
                <button id="roleSection" onclick="showRole()" class="nav-button">身份</button>
                <button id="markerButton" class="nav-button">标记</button>
            </div>

            <!-- 中间 -->
            <div class="nav-center">
                <button onclick="changeHp(1)" class="nav-button">▲</button>
                <div class="hp-display" id="hpValue">4/4</div>
                <div class="hp-display" id="armorValue">0</div>
                <button onclick="changeHp(-1)" class="nav-button">▼</button>
            </div>

            <!-- 右侧 -->
            <div class="nav-right">
                <button class="nav-button" id="tapButton">横置</button>
                <button class="nav-button" id="flipButton">翻面</button>
                <button class="nav-button" id="abolishButton">废除</button>
            </div>
        </div>
    </div>

    <!-- 废除弹窗 -->
    <div id="abolishModal" class="modal">
        <div class="modal-content">
            <h2>选择需要废除/复原的区域</h2>
            <div class="abolish-buttons">
                <button>判定区</button>
                <button>武器</button>
                <button>防具</button>
                <button>进攻马</button>
                <button>防御马</button>
                <button>宝物</button>
            </div>
            <button id="closeAbolishModal">返回</button>
        </div>
    </div>

    <!-- 势力选择弹窗 -->
    <div id="factionModal" class="modal">
        <div class="modal-content">
            <h2>选择势力</h2>
            <div class="faction-images">
                <img src="/static/icons/wei.png" alt="魏">
                <img src="/static/icons/shu.png" alt="蜀">
                <img src="/static/icons/wu.png" alt="吴">
                <img src="/static/icons/qun.png" alt="群">
                <img src="/static/icons/jin.png" alt="晋">
            </div>
            <button id="closeModal">返回</button>
        </div>
    </div>

    <!-- 身份弹窗 -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <h2>你的身份是：{{ role }}</h2>
            <button id="closeRoleModal">关闭</button>
        </div>
    </div>

    <!-- 标记输入弹窗 -->
    <div id="markerModal" class="modal">
        <div class="modal-content">
            <h2>添加标记</h2>
            <div style="margin:10px 0;">
                <label>标记名称: <input type="text" id="markerName"></label>
            </div>
            <div style="margin:10px 0;">
                <label>数量: <input type="number" id="markerCount" value="1" min="1"></label>
            </div>
            <button id="confirmMarker">确定</button>
            <button id="cancelMarker">取消</button>
        </div>
    </div>
    </div>

    <script>
        // === 状态数据 ===
        let hp = 4;
        let maxHp = 4;
        let armor = 0;
        let isTapped = false;
        let isFlipped = false;

        const charImg = document.getElementById("characterImage");
        const chainOverlay = document.getElementById("chainOverlay");
        const originalSrc = charImg ? charImg.src : "";

        // === 血量与护甲 ===
        function updateHpDisplay() {
            const hpDiv = document.getElementById("hpValue");
            hpDiv.textContent = `${hp}/${maxHp}`;
            if (maxHp === 0 || hp === 0) {
                hpDiv.style.color = "gray";
            } else if (hp === maxHp) {
                hpDiv.style.color = "green";
            } else if (hp === 2) {
                hpDiv.style.color = "orange";
            } else if (hp === 1) {
                hpDiv.style.color = "red";
            } else {
                hpDiv.style.color = "green";
            }
        }

        function updateArmorDisplay() {
            document.getElementById("armorValue").textContent = armor;
        }

        function changeHp(delta) {
            hp = Math.max(0, Math.min(maxHp, hp + delta));
            updateHpDisplay();
        }

        function changeMaxHp(delta) {
            maxHp = Math.max(0, maxHp + delta);
            if (hp > maxHp) hp = maxHp;
            updateHpDisplay();
        }

        function changeArmor(delta) {
            armor = Math.max(0, Math.min(5, armor + delta));
            updateArmorDisplay();
        }

        // === 横置、翻面 ===
        document.getElementById("tapButton").onclick = () => {
            if (!charImg) return;
            isTapped = !isTapped;
            if (isTapped) {
                chainOverlay.style.display = "block";
                chainOverlay.style.width = charImg.clientWidth + "px";
                tapButton.textContent = "竖置";
            } else {
                chainOverlay.style.display = "none";
                tapButton.textContent = "横置";
            }
        };

        document.getElementById("flipButton").onclick = () => {
            if (!charImg) return;
            isFlipped = !isFlipped;
            charImg.src = isFlipped ? "/static/icons/back.jpg" : originalSrc;
        };

        // === 势力选择 ===
        const factionIcon = document.getElementById("factionIcon");
        const factionModal = document.getElementById("factionModal");
        const closeModal = document.getElementById("closeModal");

        factionIcon.onclick = () => factionModal.style.display = "flex";
        closeModal.onclick = () => factionModal.style.display = "none";

        document.querySelectorAll(".faction-images img").forEach(img => {
            img.addEventListener("click", function () {
                factionIcon.src = this.src;
                factionModal.style.display = "none";
            });
        });

        // === 查看身份功能 ===
        const roleSection = document.getElementById("roleSection");
        const roleModal = document.getElementById("roleModal");
        const closeRoleModal = document.getElementById("closeRoleModal");

        function showRole() {
            roleModal.style.display = "flex";
        }
        if (closeRoleModal) {
            closeRoleModal.onclick = () => roleModal.style.display = "none";
        }

        // === 废除弹窗 ===
        const abolishButton = document.getElementById("abolishButton");
        const abolishModal = document.getElementById("abolishModal");
        const closeAbolishModal = document.getElementById("closeAbolishModal");

        abolishButton.onclick = () => abolishModal.style.display = "flex";
        closeAbolishModal.onclick = () => abolishModal.style.display = "none";

        // 监听六个废除按钮
        const abolishBtns = abolishModal.querySelectorAll(".abolish-buttons button");
        abolishBtns.forEach(btn => {
            btn.addEventListener("click", () => {
                const name = btn.textContent.trim();
                const markerList = document.getElementById("markerList");

                // 查找是否已有对应的“XX已废除”
                let existing = markerList.querySelector(`[data-abolish="${name}"]`);
                if (existing) {
                    // 已经存在则删除
                    existing.remove();
                } else {
                    // 否则添加
                    const row = document.createElement("div");
                    row.textContent = `${name}已废除`;
                    row.setAttribute("data-abolish", name);
                    row.style.color = "gray";
                    row.style.fontStyle = "italic";
                    row.style.padding = "3px 0";
                    markerList.appendChild(row);
                }
            });
        });

        // === 标记功能 ===
        const markerBtn = document.getElementById("markerButton");
        const markerModal = document.getElementById("markerModal");
        const confirmMarker = document.getElementById("confirmMarker");
        const cancelMarker = document.getElementById("cancelMarker");
        const markerList = document.getElementById("markerList");

        markerBtn.onclick = () => markerModal.style.display = "flex";
        cancelMarker.onclick = () => markerModal.style.display = "none";

        confirmMarker.onclick = () => {
            const name = document.getElementById("markerName").value.trim();
            let count = parseInt(document.getElementById("markerCount").value);
            if (!name || isNaN(count) || count <= 0) {
                alert("请输入正确的标记信息！");
                return;
            }
            addMarker(name, count);
            markerModal.style.display = "none";
            document.getElementById("markerName").value = "";
            document.getElementById("markerCount").value = 1;
        };

        function addMarker(name, count) {
            const row = document.createElement("div");
            row.style.display = "flex";
            row.style.alignItems = "center";
            row.style.justifyContent = "space-between";
            row.style.padding = "5px 0";
            row.style.borderBottom = "1px solid #ddd";

            const nameSpan = document.createElement("span");
            nameSpan.textContent = name;
            nameSpan.style.flex = "1";

            const countSpan = document.createElement("span");
            countSpan.textContent = count;
            countSpan.style.width = "30px";
            countSpan.style.textAlign = "center";

            const btns = document.createElement("div");
            btns.style.display = "flex";
            btns.style.gap = "5px";

            const incBtn = document.createElement("button");
            incBtn.textContent = "▲";
            incBtn.onclick = () => {
                count++;
                countSpan.textContent = count;
            };

            const decBtn = document.createElement("button");
            decBtn.textContent = "▼";
            decBtn.onclick = () => {
                if (count > 1) {
                    count--;
                    countSpan.textContent = count;
                }
            };

            const delBtn = document.createElement("button");
            delBtn.textContent = "X";
            delBtn.onclick = () => {
                if (confirm("确定要删除这个标记吗？")) {
                    row.remove();
                }
            };

            btns.appendChild(incBtn);
            btns.appendChild(decBtn);
            btns.appendChild(delBtn);

            row.appendChild(nameSpan);
            row.appendChild(countSpan);
            row.appendChild(btns);

            markerList.appendChild(row);
            console.log("Added marker:", name, count, markerList);
        }

        document.querySelectorAll(".suit").forEach(btn => {
            btn.addEventListener("click", () => {
                btn.classList.toggle("active");
            });
        });

    </script>
</body>

</html>