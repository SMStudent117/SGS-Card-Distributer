<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>移动端游戏角色操作界面（竖屏）</title>
  <style>
    :root {
      --gap: 10px;
      --top-h: 72px;
      --bottom-h: 88px;
      --nav-radius: 14px;
      --nav-bg: rgba(255, 255, 255, 0.95);
      --shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      --accent: #111;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: linear-gradient(180deg, #f3f4f6, #eef2f6);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", "Noto Sans SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      color: var(--accent);
    }

    #app {
      min-height: 100vh;
      position: relative;
      overflow: hidden;
    }

    .top-nav {
      position: fixed;
      left: var(--gap);
      right: var(--gap);
      top: var(--gap);
      height: var(--top-h);
      background: var(--nav-bg);
      border-radius: var(--nav-radius);
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      align-items: center;
      padding: 0 12px;
      z-index: 40;
      backdrop-filter: blur(6px);
    }

    .top-left {
      display: flex;
      height: 100%;
      gap: 8px;
      align-items: center;
    }

    .top-left>.half {
      flex: 1 1 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 80%;
      border-radius: 10px;
      cursor: pointer;
    }

    .top-left img {
      height: calc(var(--top-h) - 16px);
      /* 高度 = 导航栏高度 - 间隔 */
      width: auto;
      object-fit: contain;
      display: block;
    }

    .top-mid {}

    .top-right {
      display: flex;
      align-items: center;
      /* 垂直居中 */
      justify-content: center;
      /* 水平居中 */
    }

    .top-right .btn {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      font-size: 14px;
      background: transparent;
    }

    /* 中间内容区 */
    .main-content {
      position: relative;
      width: 100%;
      height: calc(100vh - var(--top-h) - var(--bottom-h) - (var(--gap)*2));
      margin-top: calc(var(--top-h) + var(--gap));
      margin-bottom: calc(var(--bottom-h) + var(--gap));
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .center {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #imageWrapper {
      position: relative;
      display: inline-block;
    }

    #characterImage {
      display: block;
      object-fit: contain;
    }

    .bottom-nav {
      position: fixed;
      left: var(--gap);
      right: var(--gap);
      bottom: var(--gap);
      height: var(--bottom-h);
      background: var(--nav-bg);
      border-radius: var(--nav-radius);
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      align-items: center;
      padding: 0 12px;
      z-index: 40;
      backdrop-filter: blur(6px);
    }

    .bottom-left,
    .bottom-right {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .bottom-right .btn {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      font-size: 14px;
      background: transparent;
    }

    .bottom-mid {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-left: 8px;
    }

    .ctrl-btn {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(0, 0, 0, 0.08);
      font-size: 20px;
      background: transparent;
    }

    .stat {
      min-width: 36px;
      text-align: center;
      font-weight: 600;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      max-width: 90%;
      text-align: center;
    }

    .faction-images {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin: 16px 0;
    }

    .faction-images img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      cursor: pointer;
    }

    .modal button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #eee;
      cursor: pointer;
    }

    .action-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      /* 两列 */
      gap: 12px;
      /* 行列间距 */
      margin-top: 20px;
    }

    .action-grid button {
      padding: 8px 12px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: #f5f5f5;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="app" data-role="{{ role }}" data-image-file="{{ image_file }}">
    <div class="top-nav">
      <div class="top-left">
        <div class="half" @click="openFactionModal">
          <img :src="factionIcon" alt="势" />
        </div>
        <div class="half" @click="openRoleModal">
          <div :style="roleStyle" v-text="roleLabel"></div>
        </div>
      </div>
      <div class="top-mid"></div>
      <div class="top-right">
        <button class="btn">设置</button>
      </div>
    </div>

    <!-- 中间主界面 -->
    <div class="main-content">
      <div class="center" id="imageContainer">
        {% if image_file %}
        <div id="imageWrapper">
          <img id="characterImage" :src="characterSrc" alt="角色">
          <!-- 链接模式覆盖层（横置时显示） -->
          <img id="chainOverlay" src="/static/icons/chain_mode.png" v-show="chainOverlayVisible"
            style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:100%; height:auto; pointer-events:none;">
        </div>
        {% else %}
        <div style="color:white;">⚠️ 没有找到角色图片</div>
        {% endif %}
      </div>
    </div>

    <div class="bottom-nav">
      <div class="bottom-left">标记</div>
      <div class="bottom-mid">
        <button class="ctrl-btn" @click="decrement">−</button>
        <div class="stat" v-text="health" :style="{ color: fractionColor }"></div>
        <div class="stat" v-text="shield"></div>
        <button class="ctrl-btn" @click="increment">+</button>
      </div>
      <div class="bottom-right">
        <button class="btn" @click="openActionMenu">操作</button>
      </div>
    </div>

    <!-- 势力选择 Modal -->
    <div v-if="showFactionModal" class="modal">
      <div class="modal-content">
        <h2>选择势力</h2>
        <div class="faction-images">
          <img src="/static/icons/wei.png" alt="魏" @click="selectFaction('/static/icons/wei.png')">
          <img src="/static/icons/shu.png" alt="蜀" @click="selectFaction('/static/icons/shu.png')">
          <img src="/static/icons/wu.png" alt="吴" @click="selectFaction('/static/icons/wu.png')">
          <img src="/static/icons/qun.png" alt="群" @click="selectFaction('/static/icons/qun.png')">
          <img src="/static/icons/jin.png" alt="晋" @click="selectFaction('/static/icons/jin.png')">
        </div>
        <button @click="closeFactionModal">返回</button>
      </div>
    </div>

    <!-- 身份 Modal -->
    <div v-if="showRoleModal" class="modal">
      <div class="modal-content">
        <h2>你的身份是：<sphenan v-text="role"></span></h2>
        <button @click="closeRoleModal">关闭</button>
      </div>
    </div>
    <!-- 操作菜单 Modal -->
    <div v-if="showActionMenu" class="modal">
      <div class="modal-content">
        <!-- 上限调整 -->
        <div style="margin-bottom:16px;">
          <span>上限</span>
          <button @click="decrementMax">−</button>
          <button @click="incrementMax">+</button>
        </div>

        <!-- 护甲调整 -->
        <div style="margin-bottom:16px;">
          <span>护甲</span>
          <button @click="decrementArmor">−</button>
          <button @click="incrementArmor">+</button>
        </div>

        <!-- 横向按钮区（2列 × 4行） -->
        <div class="action-grid">
          <button @click="tap" v-text="isTapped ? '竖置' : '横置'"></button>
          <button @click="flip">翻面</button>
          <button @click="panding">判定</button>
          <button @click="wuqi">武器</button>
          <button @click="fangjv">防具</button>
          <button @click="jingongma">进攻</button>
          <button @click="fangyuma">防御</button>
          <button @click="baowu">宝物</button>
        </div>

        <div style="margin-top:16px;">
          <button @click="closeActionMenu">关闭</button>
        </div>
      </div>
    </div>
  </div>



  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    const { createApp, ref, computed } = Vue;

    createApp({
      setup() {
        const root = document.getElementById('app');
        const role = ref(root.dataset.role || '身份');
        const imageFile = ref(root.dataset.imageFile || '');

        const health = ref('4/4');
        const shield = ref(0);

        const factionIcon = ref("/static/icons/qun.png"); // 默认势力图标

        const showFactionModal = ref(false);
        const showRoleModal = ref(false);

        const showActionMenu = ref(false);

        const isTapped = ref(false);
        const isFlipped = ref(false);

        const chainOverlayVisible = computed(() => isTapped.value);
        const characterSrc = computed(() =>
          isFlipped.value ? "/static/icons/back.jpg" : (imageFile.value ? "/static/" + imageFile.value : "")
        );


        function increment() {
          let [x, y] = health.value.split('/').map(Number);
          if (x < y) x++;
          health.value = `${x}/${y}`;
        }

        function decrement() {
          let [x, y] = health.value.split('/').map(Number);
          if (x > 0) x--;
          health.value = `${x}/${y}`;
        }

        function openFactionModal() { showFactionModal.value = true; }
        function closeFactionModal() { showFactionModal.value = false; }

        function openRoleModal() { showRoleModal.value = true; }
        function closeRoleModal() { showRoleModal.value = false; }

        function openActionMenu() { showActionMenu.value = true; }
        function closeActionMenu() { showActionMenu.value = false; }

        const roleStyle = computed(() => {
          switch (role.value) {
            case "主公":
              return { color: "red" };
            default:
              return { color: "var(--accent)" };
          }
        });

        const roleLabel = computed(() => {
          if (["忠臣", "反贼", "内奸"].includes(role.value)) {
            return "查看";
          }
          return role.value || "未分配"; // role 为空时显示默认提示
        });

        function selectFaction(iconPath) {
          factionIcon.value = iconPath;
          showFactionModal.value = false; // 选择后关闭弹窗
        }

        const fractionColor = computed(() => {
          let [x, y] = health.value.split('/').map(Number);
          if (x === y) return "green";
          else {
            if (x === 2) return "orange";
            if (x === 1) return "red";
            if (x === 0) return "gray";
          }
          return "green"; // 兜底颜色
        });

        // 修改 fraction 中的 y
        function incrementMax() {
          let [x, y] = health.value.split('/').map(Number);
          y++;
          health.value = `${x}/${y}`;
        }
        function decrementMax() {
          let [x, y] = health.value.split('/').map(Number);
          if (y > 0) y--;
          if (x > y) x = y; // 当前血量不能大于上限
          health.value = `${x}/${y}`;
        }

        // 修改护甲（0-5）
        function incrementArmor() {
          if (shield.value < 5) shield.value++;
        }
        function decrementArmor() {
          if (shield.value > 0) shield.value--;
        }

        function tap() { isTapped.value = !isTapped.value; }
        function flip() { isFlipped.value = !isFlipped.value; }

        return {
          health, shield, role, imageFile,
          roleLabel, roleStyle,
          increment, decrement,
          showFactionModal, openFactionModal, closeFactionModal,
          showRoleModal, openRoleModal, closeRoleModal,
          factionIcon, selectFaction,
          showActionMenu, openActionMenu, closeActionMenu,
          incrementMax, decrementMax,
          incrementArmor, decrementArmor,
          tap, flip,
          fractionColor, isTapped, isFlipped,
          chainOverlayVisible, characterSrc
        }
      }
    }).mount('#app');

    function resizeCharacterImage() {
      const topH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--top-h'));
      const bottomH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--bottom-h'));
      const gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap'));

      // 可用的显示区域高度（去掉导航栏和间隔）
      const availableHeight = window.innerHeight - topH - bottomH - (gap * 2);
      // 可用的显示区域宽度（去掉两侧间隔）
      const availableWidth = window.innerWidth - (gap * 2);

      const img = document.getElementById('characterImage');
      if (!img) return;

      function applyResize() {
        const naturalRatio = img.naturalWidth / img.naturalHeight; // 原始宽高比
        let finalHeight = availableHeight * 0.95; // 先用高度算
        let finalWidth = finalHeight * naturalRatio;

        // 如果宽度超出可用宽度，则改用宽度算
        if (finalWidth > availableWidth * 0.95) {
          finalWidth = availableWidth * 0.95;
          finalHeight = finalWidth / naturalRatio;
        }

        img.style.width = finalWidth + "px";
        img.style.height = finalHeight + "px";
      }

      if (img.complete) {
        applyResize();
      } else {
        img.onload = applyResize;
      }
    }

    window.addEventListener("load", resizeCharacterImage);
    window.addEventListener("resize", resizeCharacterImage);

  </script>
</body>

</html>